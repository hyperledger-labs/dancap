# Overview
This is a proof of concept lab to explore attestation options for
Hyperledger Avalon.

The code can be used to learn the call flow for ECDSA based attestation. To a
lesser degree, the project can also be used to verify the availability of
attestation components on a host (e.g. SGX and libs).

The code is written first and foremost to make the attestation API readable and
simple. It is not written to be fully secure or robust. You can treat this as a
simplified example before looking at official SGX examples.

The main attestation logic is in App/App.cpp. It loads a minimal enclave and
uses the SGX SDK methods for creating an ECDSA based attestation of that
enclave.

The complement to the enclave application is the relying party's verifier in
RelyingParty/Verifier.cpp. This program will read in a binary quote generated by
the application and verify it using SGX DCAP libraries. Those libraries rely on
a service deployed in the cloud environment or within your local enviroment.

Quote generation (creating an attestation) has been verified on Azure ACC nodes
only. Quote verification has been verified with Intel open source reference
components only.

The project also includes a Docker-based dev environment to facilitate building 
and some debugging. The app also works within that environment if the app is
built in simulation mode. Verification will correctly return errors when given
simulation quotes (because you should not trust simulated quotes). 
The container is meant for development not for deployment.
It may be possible to modify the container for deployment by
mapping in /dev/sgx and the quote provider library (libdcap_quoteprov.so)
but this has not been tested.
Similarly the verififier may be run in a container or other environment
supplying the required services and libraries to test the portability of the 
quote generated by the application.

## TODO
* Add verifier container
* Add report data to app and verifier.
* Add verifier using Quote Verification *Enclave* and/or discuss deployment
  models where Quote Verification *Library* alone makes sense (this is probably
  the most applicable model for Avalon).
* There is a known library compatibility issue with this lab and Azure at this
  time (Feb 24, 2020) that will cause verification errors.
* Print DCAP Codes nicely


# Build

## Docker

From project root
1. build the container

    `./build-docker`

1. run the container - this drops you into a shell

    `./run-container`

1. build in hardware mode [default] or simulation mode

    `make clean && make`

    or

    `SGX_MODE=SIM make clean && make`
    
    This will produce an enclave application, `attestor`, built for hardware or
    simulation and a verifier which does not rely on hardware but does rely on
    DCAP services.

## Ubuntu 18.04
1. Install machine per instructions in [Cloud Provisioning](#cloud-provisioning)

1. build in hardware mode (default) or simulation mode

    `make clean && make`

    or

    `SGX_MODE=SIM make clean && make`


# Running
(Note: when run within the dev container only simulation mode binary of the
attestor app will work.
However if you build in HW mode the binary will work on Ubuntu natively.)
    
1. Create an attestation (also called generating a quote)

    `./attestor`

    This outputs a binary file `attestation.bytes`.

1. Verify the attestation

    `./verifier`

    This consumes the attestation file and indicates whether it is acceptable.
    Note that there is a version incompatibility with Azure at the time of this
    writing (Feb 24, 2020). However verification will pass if you instead use
    the reference by installing it in your local environment. See: 
    https://github.com/intel/SGXDataCenterAttestationPrimitives/tree/master/QuoteGeneration/pccs


# Cloud Provisioning
## Azure Confidential Compute
1. Provision an ACC node with
    * Ubuntu 18.04
    * Open Enclave SDK 
    ** This is necessary to get the attestation dependencies installed correctly within Azure.
    See:
    https://software.intel.com/en-us/articles/get-started-with-azure-confidential-computing
    for more details.

1. Upgrade the machine
    `apt-get update && apt-get upgrade`

1. Install the Intel(r) SGX SDK
```
    wget \
       https://download.01.org/intel-sgx/sgx-linux/2.7.1/distro/ubuntu18.04-server/sgx_linux_x64_sdk_2.7.101.3.bin \
       && chmod +x sgx_linux_x64_sdk_2.7.101.3.bin \
       && echo "yes" | ./sgx_linux_x64_sdk_2.7.101.3.bin \
       && rm sgx_linux_x64_sdk_2.7.101.3.bin \
       && echo "source /opt/intel/sgxsdk/environment" >> /etc/environment`
```

1. Set library search order to pick up Azure's quote provider library rather
    than the one available in the SGX common path. You can do this the right
    way by managing /etc/ld.so.conf Or you can do it the expedient way by
    removing the one we don't want.

    We want this one:  
    `$ /usr/lib/libdcap_quoteprov.so`

    we do NOT want this one:  
    ~~$ /opt/intel/libsgx-enclave-common/aesm/libdcap_quoteprov.so~~

# Misc
The project has a helper function to print SGX error codes and messages.
This helper function can be regenerated if the SGX SDK changes using the
python script in App/:

`App/generate_handle_sgx_error.py > App/handle_sgx_error.h`

DCAP codes output by the verifier can be looked up here:
https://github.com/intel/SGXDataCenterAttestationPrimitives/blob/master/QuoteGeneration/quote_wrapper/common/inc/sgx_ql_lib_common.h

and here:

https://github.com/intel/SGXDataCenterAttestationPrimitives/blob/master/QuoteVerification/QvE/Include/qve_header.h

